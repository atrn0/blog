---
title: Goのよくあるミスを発見する静的解析ツールを作った話
date: 2020-09-04T00:00:00+09:00
draft: false
description:
categories:
  - 開発
tags:
  - Go
  - 静的解析
eyecatch: /posts/itervar/ogp.jpg
share: true
---

こんにちは [@p1ass](https://twitter.com/p1ass) です。
Go のよくある間違いとして、ループのイテレーター変数の参照をループの中でとってしまうという間違いがあります。
イテレーター変数は 1 イテレーションごとにアドレスが変わらないので、「この参照をそのまま配列に append すると配列の結果が全て同じ値になってしまう」といったことが発生してしまいます。この問題はよくある間違いとして Go の wiki にも取り上げています。しかし、現状では公式でこの間違いを検出する静的解析ツールは用意されていません。

そこで、僕はメルカリのインターンで イテレーター変数の参照をループ内で使ってしまっているコードを検出する静的解析ツールを作成したのでそれを紹介したいと思います。

## Using reference to loop iterator variable

今回対象とした間違いである「Using reference to loop iterator variable」についてもう少し詳しく紹介します。

[CommonMistakes · golang/go Wiki](https://github.com/golang/go/wiki/CommonMistakes)

具体的なサンプルコードは以下の通りです。

```go

```

このコードを実行すると、`out` の中身は`{3}, {3}, {3}` と、同じ値になってしまいます。

この間違いの対策はいたって簡単です。イテレーター変数をブロックの最初で再定義してしまえば ok です。再定義することでイテレーションのたびにポインターのアドレスが変わるので、問題なく想定通りの挙動をしてくれます。

以前 Let's Enctypt がこの間違いをおかしてしまい 、障害に陥ってしまったこともあります。かく言う僕も実際にこのバグを踏んでしまったことがあります。(以前ブログに書きました。)
しかしこの間違いは頻出なのにもかかわらず、go vet 等の標準の静的解析ツールでは検出してくれません。
非常に有名な問題なので以前から「公式で静的解析ツールを用意すべきなのでは」と言う意見が上がっているのですが、今のところ導入される予定はなく、Russ Cox は 「Go2 でこの挙動はそもそも起きないようにしたい」みたいなことを言っていました。

## 作ったもの

実際に作った生的解析ツールの名前は itervar です。イテレータ変数が再定義されていなかったら検出してくれます。

こちらの GitHub からソースコードを見ることができます。
使い方としては go get でバイナリをダウンロードした後に、go vet の `-vettool`で itervar を選択して使います。先程の例であれば、7 行目の部分でエラーが表示されます。

```shell script

```

## 実装方針

さて、ここからはこのツールの実装について紹介したいと思います。
このツールは goanalysis オーガナイゼーションでポスティングされている skeleton と言う CLI ツールを使って雛形を作成しています。

このツールを使うとアナライザーパッケージを使ってた雛形のソースコードが生成されるだけでなく、テストデータを一緒に作ってくれます。これにより静的解析のロジックに集中して、静的解析ツールを作成することができます。

さて、このメールでレーター変数三枝様を検出する実装方針ですか、まず for 文と range 文を探索して見つけます。その後。そこで定義されているイテレーター変数の識別子を取得します。最後に。ブロック内でその変数が使われている箇所を探し、そこで参照を取っていたらエラーを出す、という実装になっています。
ロジックとしてはかなりシンプルであり、静的解析に詳しくない方でも読めるではないかなと思っています。

このツールを作る上でいくつか注意した点があるのですが、最も大事なのは、**「変数名が同じだからといって必ずしもそれらが同じ変数であるとは限らない」** と言う点です。

Go では同じ名前の変数を後スコープの中で定義することができます。例えば、次のようなコードでは AI と言う変数を 2 回定義していますが問題なく動きます。

```go

```

したがって、この場合エス子スコープの中の愛の山椒をとっている部分ではエラーを出してはいけません。幸いにも今回の書いたコードではオブジェクトのポイントが一致すればエラーを出すと言うふうな実装になっているので、同じ変数であればそのポイントが一緒になるので問題なく動作するようになっています。

## 終わりに

初めて Go の静的解析ツールを 1 から作りましたが、「思ったより簡単に作れたな」というのが正直な感想です。もともと SD 等は知っていましたか色と文の違い等は少し曖昧な知識しかありませんでしたが、それでも三日間で今これだけのものが作れたのは、 Go の静的解析のしやすさのおかげなのかなと思っています。

皆さんもぜひ何か静的解析ネタ思いついたら作ってみてください。
