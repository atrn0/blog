---
title: NODE_ENVで環境変数を管理すると辛いよねって話
date: 2020-11-10T20:40:00+09:00
draft: false
description:
categories:
  - 開発
tags:
  - Node
  - 環境変数
  - direnv
share: true
---

こんにちは、[@p1ass](https://twitter.com/p1ass) です。

最近、身内で Node における環境変数について軽く Slack で議論したことがあって、議論後も色々と考えたのでその考えをまとめておく。

基本的にサーバサイドにおける話をするが、フロントエンドにも通じる話だと思う。

結論から言うと、

- `NODE_ENV` は `development` と `production` の 2 値しか取らないようにする
- `NODE_ENV` で `.env` を切り替えない
- そもそも環境変数は `.env` のようにファイルとして管理せずランタイムで注入するようにする
- それでも `.env` を使いたい場合は `.ts` ファイルに書いたほうが得策のでは？

を意識すると、良い感じに管理できるのかと思った。

<!--more-->

## `NODE_ENV` に `development`、`production` 以外が入るややこしさ

例えば、`NODE_ENV` に `staging` が入っていた際にビルドツールがプロダクションビルドしてくれるかどうかはそのツール次第。
直感的には、デフォルトが`development` なので、プロダクションビルドはしてくれなさそう。けど、ステージング環境ならプロダクションビルドして欲しい。
みたいな歪みが生じる。

例えば、GAE は全て `production` になる。たとえそれがステージング環境だとしても。
https://cloud.google.com/appengine/docs/flexible/nodejs/runtime

このような背景があるので、基本的に `NODE_ENV` は `development` と `production` の 2 値しか取らないように設計した方が変な誤解がなくなってよい。

## `NODE_ENV` と `.env`

`NODE_ENV` を 2 値しか取らないようにすると困るのが環境変数の管理である。

Node の設定の管理として有名な config は NODE_ENV を見て設定ファイルを切り替えるし、Next.js であれば `NODE_ENV` を見て `.env.development` や `.env.production` を読み込む。

https://nextjs.org/docs/basic-features/environment-variables
(Next の推奨からは外れることに注意)

しかし、上記のように `NODE_ENV` を 2 値しか取らないようにすると、開発がスケールしてステージング環境や QA 環境としった環境が新たに増えると、この方法はスケールしなくなる。

この問題は 12 Factor App でも語られていて、「開発環境がスケールしても問題ないように環境変数を使ってデプロイごとに設定を書き換えられるようにしろ」と言ってる。
Next.js のパターンでは環境変数を使っているのにも関わらず環境ごとのファイルで管理しているので、環境変数を使っているメリットが失われている。

TODO: .env で指定されている環境変数がランタイムに設定されていたときの挙動を確認

このように環境変数をファイル(`.env`)で管理すると大規模開発ではやっていけなくなる。

Node のアプリケーション内から.env を読み込むのはやめ、素直にマシンから環境変数を渡すようにすると幸せになれる。

ローカルであれば direnv を使えば楽に環境変数を設定できる。
リポジトリには `.env.example` のような例だけを用意しておけばよい。

このように環境変数を読み込むようにすることで、環境変数の管理が `NODE_ENV` と分離されるのも良いメリットの一つである。
`NODE_ENV` が 2 値しか取らなくても問題なくスケールする。

## それでも .env で管理したい

この場合はおそらくそれら設定はそもそも環境変数で設定すべきものではない説がある。

わざわざファイルで管理したいということは環境ごとにほとんど値が変わらないからである。そして、それをコピペするのが面倒くさいからである。
しかし、よく考えてみるとコピペをするような設定ということは、そもそも環境変数として設定する必要がないのでは？と振り返ってみると良いと思う。
git で管理できるような設定ということは秘匿情報でもないし、コピペということはほとんど値が変わらないわけである。

<!-- それならば、 `config.ts` のようなファイルでデフォルト値を管理すれば、型も付くし便利に扱える。 -->

12 Factor App における 「アプリケーション内部の設定」を環境変数で設定しているオーバーエンジニアリング？になってないか確認してみると良い。

TODO この章主張が怪しい(そもそもめんどいと思ったことがない)

## 環境がスケールしないからリポジトリに含めたい

この場合はリポジトリに含めてしまっても良いと思ってる。
マシンの環境変数に設定するのは環境がスケールしても良いようにするためなので、その前提がなければ問題はない。

しかし、少なくともローカル環境、プロダクション環境は必ず存在し、ほとんどのプロジェクトでステージング環境やそれに類似するものは存在する。
また、テスト用の環境(GitHub Action など)も含めれば、4 つも環境が存在する。
それでもファイルで管理して問題ないと思うのなら、ファイルで管理すれば良いと思う。

## 結局どう管理すればいいの？

やることは単純だ。
Node の外側、マシンやシェルに環境変数を設定する。Node のアプリケーションはただそれを読むだけで良い。
環境なんてものは気にせず、ただ読み込む。デフォルト値が必要であれば設定するし、バリデーションが必要であれば、適当なライブラリを使って確かめれば良い。
TODO 適当なライブラリは調べておこうね！

```typescript
export const config = {
	apiEndpoint: process.env.API_ENDPOINT | 'localhost:8080'
	logLevel: process.env.LOG_LEVEL | 'INFO'
}
```

## まとめ

最初にも書いたが、

- `NODE_ENV` は `development` と `production` の 2 値しか取らないようにする
- `NODE_ENV` で `.env` を切り替えない
- そもそも環境変数は `.env` のようにファイルとして管理せずランタイムで注入するようにする
- それでも `.env` を使いたい場合は `.ts` ファイルに書いたほうが得策のでは？

を意識すると、良い感じに管理できるはずである。
もっとより良い方法があったら教えて欲しい。
