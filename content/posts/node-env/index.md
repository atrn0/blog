---
title: NODE_ENV で環境変数を切り変えると辛いよねって話
date: 2020-11-10T20:40:00+09:00
draft: false
description:
categories:
  - 設計
tags:
  - Node
  - 環境変数
  - direnv
share: true
---

最近、身内で Node における `NODE_ENV` と環境変数の設定方法について Slack で軽く議論したんだけど、その後色々と考えるものがあったのでここにまとめておく。

基本的にサーバサイドを前提とした話をするが、フロントエンドにも通じる話だと思うし、Next.js の話も出てくる。

結論から言うと、

- `NODE_ENV` は `development` と `production` の 2 値しか取らないようにする
- `NODE_ENV` で `.env` を切り替えない
- そもそも環境変数は `.env` のようにファイルとして管理せずランタイムで注入するようにする
- それでも `.env` を使いたい場合は `.ts` ファイルに書いたほうが得策のでは？

を意識すると、良い感じに管理できると思った。

<!--more-->

## `NODE_ENV` に `development`、`production` 以外が入るややこしさ

自分はずっと Go のサーバサイド界隈にいて、Node のサーバサイドプロジェクトに入ったのはつい 1 年以内の話なんだけど、Node のエコシステムにおける特徴的なものとして `NODE_ENV` があると思ってる。

様々なツールが `NODE_ENV` を見て、`development`であれば開発用のトレースやログを出してくれるし、`production` であれば本番用に最適化された処理を行ってくれる。
他の言語でもリリースビルドやデバッグビルドという概念でコンパイラが同じようなことをやってくれる言語も存在するけど、サードパーティのライブラリまでもが `NODE_ENV` という共通仕組みの上に載ってるのは珍しいと思う。

これはこれで便利なんだけど、環境(`ENV`)という言葉に釣られて、デプロイ環境の名称を `NODE_ENV` に設定し始めると途端にややこしくなることが多い。

よくある例として、ステージング環境の `NODE_ENV` を `staging` に設定する例を考える。

このとき、あなた使っているビルドツールやライブラリが `development` と `production` のどちらの挙動をするか正しく把握しているだろうか？
個人的には `development` の設定が優先されそう、って直感的に思うけど、確証はない。また、これはライブラリごとに挙動が統一されている保証がないので、それぞれ個別に調べる必要がある。

また、「ステージング環境だけど、本番環境と同じ環境にしたいからプロダクションビルドして欲しい」みたいな要望があると、ステージング環境なのに `NODE_ENV=production` を設定するという歪みが生じて辛くなる。

こういった歪みを考えていくと、`NODE_ENV` にデプロイ環境の名前をつけるの辞めたほうが良さそうに思える。 **基本的に `NODE_ENV` はデフォルトで使われる `development` と `production` の 2 値しか取らないように設計し、設定は `NODE_ENV` によらない形(環境変数など)で切り替えられるようにすると良い。**

## `NODE_ENV` と `.env`

`NODE_ENV` を 2 値に絞るにあたって、「そういえばなんで `NODE_ENV` にいろんな値を入れてたんだっけ？」と改めて考えてみると、大体の場合は「設定値の変更」のためにやっているパターンが多い。

例えば、Node の設定ファイルの管理として有名で頻繁に使っている node-config は `NODE_ENV` を見て、 `development.json` や `production.ts` といった設定ファイルを読み込む。
また、Next.js であれば `NODE_ENV` を見て `.env.development` や `.env.production` を読み込む。

{{<ex-link url="https://github.com/lorenwest/node-config">}}

{{<ex-link url="https://nextjs.org/docs/basic-features/environment-variables" >}}

しかし、`NODE_ENV` が 2 値しか取らないように制限をかけると、このような設定の管理方法は通用しなくなる。 `NODE_ENV` を使わない別のアプローチを探す必要がある。それが環境変数である。

開発がスケールしてステージング環境や QA 環境としった環境が新たに増えると、この方法はスケールしなくなる。

(Next の推奨からは外れることに注意)

この問題は 12 Factor App でも語られていて、「開発環境がスケールしても問題ないように環境変数を使ってデプロイごとに設定を書き換えられるようにしろ」と言ってる。
Next.js のパターンでは環境変数を使っているのにも関わらず環境ごとのファイルで管理しているので、環境変数を使っているメリットが失われている。

TODO: .env で指定されている環境変数がランタイムに設定されていたときの挙動を確認

このように環境変数をファイル(`.env`)で管理すると大規模開発ではやっていけなくなる。

Node のアプリケーション内から.env を読み込むのはやめ、素直にマシンから環境変数を渡すようにすると幸せになれる。

ローカルであれば direnv を使えば楽に環境変数を設定できる。
リポジトリには `.env.example` のような例だけを用意しておけばよい。

このように環境変数を読み込むようにすることで、環境変数の管理が `NODE_ENV` と分離されるのも良いメリットの一つである。
`NODE_ENV` が 2 値しか取らなくても問題なくスケールする。

## それでも .env で管理したい

設定値が多すぎて環境変数だとしんどい

この場合はおそらくそれら設定はそもそも環境変数で設定すべきものではない説がある。

わざわざファイルで管理したいということは環境ごとにほとんど値が変わらないからである。そして、それをコピペするのが面倒くさいからである。
しかし、よく考えてみるとコピペをするような設定ということは、そもそも環境変数として設定する必要がないのでは？と振り返ってみると良いと思う。
git で管理できるような設定ということは秘匿情報でもないし、コピペということはほとんど値が変わらないわけである。

<!-- それならば、 `config.ts` のようなファイルでデフォルト値を管理すれば、型も付くし便利に扱える。 -->

12 Factor App における 「アプリケーション内部の設定」を環境変数で設定しているオーバーエンジニアリング？になってないか確認してみると良い。

TODO この章主張が怪しい(そもそもめんどいと思ったことがない)

## 環境がスケールしないからリポジトリに含めたい

この場合はリポジトリに含めてしまっても良いと思ってる。
マシンの環境変数に設定するのは環境がスケールしても良いようにするためなので、その前提がなければ問題はない。

しかし、少なくともローカル環境、プロダクション環境は必ず存在し、ほとんどのプロジェクトでステージング環境やそれに類似するものは存在する。
また、テスト用の環境(GitHub Action など)も含めれば、4 つも環境が存在する。
それでもファイルで管理して問題ないと思うのなら、ファイルで管理すれば良いと思う。

## 結局どう管理すればいいの？

やることは単純だ。
Node の外側、マシンやシェルに環境変数を設定する。Node のアプリケーションはただそれを読むだけで良い。
環境なんてものは気にせず、ただ読み込む。デフォルト値が必要であれば設定するし、バリデーションが必要であれば、適当なライブラリを使って確かめれば良い。
TODO 適当なライブラリは調べておこうね！

```typescript
export const config = {
	apiEndpoint: process.env.API_ENDPOINT | 'localhost:8080'
	logLevel: process.env.LOG_LEVEL | 'INFO'
}
```

## まとめ

最初にも書いたが、

- `NODE_ENV` は `development` と `production` の 2 値しか取らないようにする
- `NODE_ENV` で `.env` を切り替えない
- そもそも環境変数は `.env` のようにファイルとして管理せずランタイムで注入するようにする
- それでも `.env` を使いたい場合は `.ts` ファイルに書いたほうが得策のでは？

を意識すると、良い感じに管理できるはずである。
もっとより良い方法があったら教えて欲しい。
